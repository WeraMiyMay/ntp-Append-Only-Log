# npt ‚Äî Non‚ÄëPrintable Trace Format üîí

–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç append‚Äëonly –ª–æ–≥–æ–≤ —Å **–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏**, **—Ü–µ–ø–æ—á–∫–æ–π —Ö—ç—à–µ–π**, –±–∏–Ω–∞—Ä–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –∏ CLI‚Äë—É—Ç–∏–ª–∏—Ç–æ–π `npt.php`.

–§–æ—Ä–º–∞—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π —Å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–º–µ—Ç–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
* PHP 8.4+
* –†–∞—Å—à–∏—Ä–µ–Ω–∏—è:
  * `ext-sodium`
  * `ext-json`
* –†–µ–∂–∏–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è: —Ç–æ–ª—å–∫–æ CLI
* –ë–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ (—Å—Ç—Ä–æ–≥–∏–µ —Ç–∏–ø—ã `declare(strict_types=1);`)

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

```
php npt.php init
```

–°–æ–∑–¥–∞—ë—Ç:

* `data.npt` ‚Äî –±–∏–Ω–∞—Ä–Ω–æ–µ append‚Äëonly —Ö—Ä–∞–Ω–∏–ª–∏—â–µ  
* `keys.json` ‚Äî ed25519 –∫–ª—é—á–∏ (public/secret + seed)  
* `allowlist.json` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π  

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ allowlist –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è **–≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á**.

---

## ‚úçÔ∏è –ó–∞–ø–∏—Å—å –ª–æ–≥–æ–≤

### –ó–∞–ø–∏—Å—å –∏–∑ STDIN

PowerShell / bash –æ–¥–∏–Ω–∞–∫–æ–≤–æ:

```
echo '{"a":1,"b":"test"}' | php npt.php write --stdin
```

–ö–æ–º–∞–Ω–¥–∞:

* –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç JSON  
* –≤—ã—á–∏—Å–ª—è–µ—Ç `ts`  
* –¥–æ–±–∞–≤–ª—è–µ—Ç –±–ª–æ–∫ –≤ `data.npt`  
* –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –±–ª–æ–∫ —Ç–µ–∫—É—â–∏–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º  
* –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –≤ allowlist  

---

## üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–æ–≤

### –®–∞–±–ª–æ–Ω JSON

```
echo '{"type":"event","level":"info","msg":"hello"}' > template.json
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ —à–∞–±–ª–æ–Ω—É

```
php npt.php generate --count 3 --template template.json
```

–í —à–∞–±–ª–æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è:

* `id` ‚Äî –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤–Ω—É—Ç—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏  
* `ts` ‚Äî timestamp  

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –±–ª–æ–∫–æ–≤

```
php npt.php generate --count 5 --random
```

---

## üìñ –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —á—Ç–µ–Ω–∏–µ:

```
php npt.php read
```

–ß—Ç–µ–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º:

```
php npt.php read --limit 10
```

–ß—Ç–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏:

```
php npt.php read --from 0
```

–í—ã–≤–æ–¥ —Ö—ç—à–µ–π –≤ hex:

```
php npt.php read --hex
```

---

## üîç –ü–æ–∏—Å–∫

–ü–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ (–≤ —Å—ã—Ä–æ–º JSON):

```
php npt.php search --q error
```

–ü–æ –ø–æ–ª—é JSON (—á–∏—Å–ª–∞, —Å—Ç—Ä–æ–∫–∏, boolean):

```
php npt.php search --field level=info
```

–ü–æ –∞–≤—Ç–æ—Ä—É –±–ª–æ–∫–∞ (–ø—É–±–ª–∏—á–Ω–æ–º—É –∫–ª—é—á—É –≤ hex):

```
php npt.php search --pub abcd1234...
```

–ü–æ –≤—Ä–µ–º–µ–Ω–∏:

```
php npt.php search --since 1700000000
php npt.php search --until 1700100000
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

```
php npt.php verify
```

–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

1. **–°—Ç—Ä—É–∫—Ç—É—Ä—É –±–ª–æ–∫–∞**  
2. **PREV-—Ü–µ–ø–æ—á–∫—É**  
3. **SIG ‚Äî –ø–æ–¥–ø–∏—Å—å**  
4. **HASH ‚Äî —Ö—ç—à –±–ª–æ–∫–∞**  
5. **Allowlist ‚Äî —á—Ç–æ –∞–≤—Ç–æ—Ä —Ä–∞–∑—Ä–µ—à—ë–Ω**  

–û—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã:

* –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è payload  
* –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞  
* –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –±–∞–π—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞  
* –≤—Å—Ç–∞–≤–∫–∞ –º—É—Å–æ—Ä–∞ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏  
* –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π LEN  
* –Ω–µ–≤–µ—Ä–Ω—ã–π MAGIC  
* –Ω–∞—Ä—É—à–µ–Ω–∏–µ PREV‚Äë—Ü–µ–ø–æ—á–∫–∏  

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è:

* offset –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞  
* —Ç–∏–ø –æ—à–∏–±–∫–∏  

---

## üì§ –≠–∫—Å–ø–æ—Ä—Ç NDJSON

```
php npt.php export > logs.ndjson
```

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ ‚Äî –ø–æ –æ–¥–Ω–æ–º—É JSON‚Äë–æ–±—ä–µ–∫—Ç—É –Ω–∞ —Å—Ç—Ä–æ–∫—É:

* offset  
* ts  
* payload  
* pub  
* hash  
* prev  

---

# üì¶ –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç NPT

–•—Ä–∞–Ω–∏–ª–∏—â–µ: –æ–¥–∏–Ω —Ñ–∞–π–ª `data.npt`, **append‚Äëonly**, –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –±–ª–æ–∫.

–ö–∞–∂–¥—ã–π –±–ª–æ–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```
MAGIC(6)     = "NOVIJ1"
LEN(4, BE)      –¥–ª–∏–Ω–∞ BODY –≤ –±–∞–π—Ç–∞—Ö (—Ü–µ–ª–æ–µ –±–µ–∑ –∑–Ω–∞–∫–∞)
TS(8, BE)       unix time (int64)
PREV(32)        sha256 –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å–∏ (–∏–ª–∏ 32 –Ω—É–ª—è –¥–ª—è –ø–µ—Ä–≤–æ–π)
PLEN(4, BE)     –¥–ª–∏–Ω–∞ payload
PAYLOAD(PLEN)   JSON (UTF‚Äë8)
PUB(32)         –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á ed25519 (raw)
SIG(64)         –ø–æ–¥–ø–∏—Å—å ed25519 –æ—Ç sha256(TS|PREV|PAYLOAD)
HASH(32)        sha256 –≤—Å–µ–≥–æ –±–ª–æ–∫–∞ –æ—Ç LEN –¥–æ SIG –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
```

–ì–¥–µ:

* **BODY** = `TS + PREV + PLEN + PAYLOAD + PUB + SIG`  
* **HASH** –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ BODY  

### –ß—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è?

```
SIG = ed25519_sign( sha256(TS | PREV | PAYLOAD) )
```

### –ß—Ç–æ —Ö—ç—à–∏—Ä—É–µ—Ç—Å—è?

```
HASH = sha256( LEN | BODY )
```

### –ß—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç–∞?

* TS ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è  
* PREV ‚Äî —Å–≤—è–∑—ã–≤–∞–µ—Ç –±–ª–æ–∫–∏ —Ü–µ–ø–æ—á–∫–æ–π  
* SIG ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ø–æ–¥–¥–µ–ª–∫—É –±–µ–∑ –∫–ª—é—á–∞  
* HASH ‚Äî –∑–∞—â–∏—â–∞–µ—Ç —Ç–µ–ª–æ –±–ª–æ–∫–∞ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è  
* MAGIC ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–º–µ—â–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏  

---

# üîó –ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ø–æ—á–∫–∏

–ê–ª–≥–æ—Ä–∏—Ç–º `verify` –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

1. –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ MAGIC  
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã LEN (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∞)  
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ HASH  
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ PREV == hash –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±–ª–æ–∫–∞  
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ed25519  
6. –ü—Ä–æ–≤–µ—Ä–∫–∞ allowlist  

–õ—é–±–∞—è –æ—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç offset.

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏:

* –∏–∑–º–µ–Ω—ë–Ω payload ‚Üí –æ—à–∏–±–∫–∞ SIG  
* –∏–∑–º–µ–Ω—ë–Ω prev/hash ‚Üí —Ä–∞–∑—Ä—ã–≤ —Ü–µ–ø–æ—á–∫–∏  
* –æ–±—Ä–µ–∑–∞–Ω –±–ª–æ–∫ ‚Üí –æ—à–∏–±–∫–∞ body truncated  
* –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –±–∞–π—Ç—ã ‚Üí –æ—à–∏–±–∫–∞ MAGIC mismatch  

---

# ‚õìÔ∏è CLI‚Äë–∫–æ–º–∞–Ω–¥—ã (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)

```
php npt.php init
php npt.php write --stdin
php npt.php generate --count N [--template file.json | --random]
php npt.php read [--from OFFSET] [--limit N] [--hex]
php npt.php verify
php npt.php export
php npt.php search [--q S] [--field key=value] [--since TS] [--until TS] [--pub HEX]
```

–í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –ø–æ—Ç–æ–∫–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç—å.

---

# ü§ñ –†–∞–∑–¥–µ–ª ¬´AI‚Äë–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ¬ª

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:
* –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ CLI  
* –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞  
* –ø–æ–º–æ—â—å —Å —Ä–µ–≥—É–ª—è—Ä–∫–∞–º–∏, BOM, UTF‚Äë16  
* —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö  
* —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ README
* –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ edge‚Äëcases 

### –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–æ –≤—Ä—É—á–Ω—É—é:
* —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞  
* ed25519-–ø–æ–¥–ø–∏—Å—å –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞  
* —Ü–µ–ø–æ—á–∫–∞ PREV  
* —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HASH  
* —Ä–∞–±–æ—Ç–∞ —Å allowlist  
* –≤–µ—Å—å –≤–≤–æ–¥-–≤—ã–≤–æ–¥ –∏ –ø–æ—Ç–æ–∫–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤  

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤—Ä—É—á–Ω—É—é:
* hex‚Äë–¥–∞–º–ø—ã –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞  
* —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ PREV —Ü–µ–ø–æ—á–∫–µ  
* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å SIG –∏ HASH  
* –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä—ã–≤–µ, –≤—Å—Ç–∞–≤–∫–µ –º—É—Å–æ—Ä–∞, –Ω–µ–≤–µ—Ä–Ω–æ–º MAGIC  
* –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ read / verify / export / search  

---

